<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HypeAI Чат</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #a5b1c2;
        }
        
        .beta-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f72585, #b5179e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        
        .beta-btn:hover {
            transform: translateY(-2px);
        }
        
        .app-container {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .model-selector {
            margin-bottom: 20px;
        }
        
        .model-selector h3 {
            margin-bottom: 10px;
            color: #4cc9f0;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }
        
        select option {
            background: #1a1a2e;
        }
        
        .api-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .api-info h4 {
            margin-bottom: 10px;
            color: #4cc9f0;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h2 {
            color: #4cc9f0;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 15px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .user-message .message-sender {
            color: #4cc9f0;
        }
        
        .ai-message .message-sender {
            color: #f72585;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input input {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #4cc9f0;
        }
        
        .chat-input button {
            padding: 15px 25px;
            border-radius: 8px;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .chat-input button:hover {
            transform: translateY(-2px);
        }
        
        .chat-input button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-btn {
            padding: 15px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f72585, #b5179e);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .voice-btn.listening {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px;
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border-bottom-left-radius: 5px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #a5b1c2;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .play-audio-btn {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .play-audio-btn.playing {
            background: linear-gradient(135deg, #f72585, #b5179e);
        }
        
        /* Beta Interface Styles */
        .beta-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .beta-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .beta-title {
            font-size: 3rem;
            background: linear-gradient(90deg, #4cc9f0, #f72585);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .beta-subtitle {
            color: #a5b1c2;
            font-size: 1.2rem;
        }
        
        .voice-visualizer {
            width: 300px;
            height: 100px;
            margin: 30px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }
        
        .bar {
            width: 4px;
            background: linear-gradient(to top, #4cc9f0, #f72585);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .transcript-display {
            min-height: 80px;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .beta-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .beta-command {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .hype-btn {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #f72585, #b5179e);
        }
        
        .beta-command:hover {
            transform: translateY(-3px);
        }
        
        .beta-response {
            max-width: 600px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .close-beta {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .command-hint {
            color: #a5b1c2;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #a5b1c2;
            font-size: 0.9rem;
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input {
                flex-wrap: wrap;
            }
            
            .voice-btn {
                order: -1;
            }
            
            .beta-controls {
                flex-direction: column;
            }
            
            .beta-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HypeAI Чат</h1>
            <p class="subtitle">Продвинутый искусственный интеллект для общения</p>
            <button class="beta-btn" id="beta-btn">BETA</button>
        </header>
        
        <div class="app-container">
            <div class="sidebar">
                <div class="model-selector">
                    <h3>Выберите модель</h3>
                    <select id="model-select">
                        <option value="deepseek-ai/DeepSeek-R1-0528" selected>DeepSeek R1</option>
                        <option value="meta-llama/Llama-3.3-70B-Instruct">Llama 3.3 70B</option>
                        <option value="meta-llama/Llama-3.2-90B-Vision-Instruct">Llama 3.2 90B Vision</option>
                        <option value="meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8">Llama 4 Maverick</option>
                        <option value="mistralai/Mistral-Nemo-Instruct-2407">Mistral Nemo</option>
                        <option value="mistralai/Mistral-Large-Instruct-2411">Mistral Large</option>
                    </select>
                </div>
                
                <div class="api-info">
                    <h4>О HypeAI</h4>
                    <p>HypeAI использует передовые модели искусственного интеллекта для общения.</p>
                    <p>Поддерживает текстовый и голосовой ввод!</p>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <h2>Чат с HypeAI</h2>
                    <div class="status">
                        <div class="status-indicator" id="status-indicator"></div>
                        <span id="status-text">Готов к общению</span>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai-message">
                        <div class="message-sender">HypeAI</div>
                        <div class="message-content">Привет! Я HypeAI - ваш AI-ассистент. Можете писать сообщения или использовать голосовой ввод!</div>
                    </div>
                </div>
                
                <div class="chat-input">
                    <button class="voice-btn" id="voice-btn" title="Голосовой ввод">🎤</button>
                    <input type="text" id="message-input" placeholder="Введите ваше сообщение или используйте голосовой ввод...">
                    <button id="send-button">Отправить</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>HypeAI Chat &copy; 2026 | Передовые технологии ИИ</p>
        </footer>
    </div>

    <!-- Beta Interface -->
    <div class="beta-interface" id="beta-interface">
        <button class="close-beta" id="close-beta">×</button>
        <div class="beta-header">
            <h1 class="beta-title">HypeAI BETA</h1>
            <p class="beta-subtitle">Продвинутый голосовой интерфейс</p>
            <p class="command-hint">Голосовые команды: "отмена", "хайп", "стоп"</p>
        </div>
        
        <div class="voice-visualizer" id="voice-visualizer">
            <!-- Bars will be generated by JavaScript -->
        </div>
        
        <div class="transcript-display" id="transcript-display">
            Говорите... Ваша речь будет отображаться здесь
        </div>
        
        <div class="beta-controls">
            <button class="beta-command cancel-btn" id="beta-cancel">Отмена</button>
            <button class="beta-command hype-btn" id="beta-hype">Хайп</button>
            <button class="beta-command stop-btn" id="beta-stop">Стоп</button>
        </div>
        
        <div class="beta-response" id="beta-response">
            <div class="message-sender">HypeAI</div>
            <div class="message-content" id="beta-response-content"></div>
        </div>
    </div>

    <script>
        // API ключ
        const API_KEY = "io-v2-eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJvd25lciI6ImFkZTA2MWNkLTFhMWUtNDY0OC04OGI1LWQ1ZWEzZDA2ZDgzYyIsImV4cCI6NDkxMjY3NDkxNn0.Jbx295su4HCFHLiNQZDArtDq-0l9nbH18PX6ljGZqfbM2p7X7-Dy4IHJ97EZJVNiwTikrnIXWMT25PN0TzwfwA";
        
        // Элементы DOM
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const voiceBtn = document.getElementById('voice-btn');
        const betaBtn = document.getElementById('beta-btn');
        const betaInterface = document.getElementById('beta-interface');
        const closeBeta = document.getElementById('close-beta');
        const voiceVisualizer = document.getElementById('voice-visualizer');
        const transcriptDisplay = document.getElementById('transcript-display');
        const betaCancel = document.getElementById('beta-cancel');
        const betaHype = document.getElementById('beta-hype');
        const betaStop = document.getElementById('beta-stop');
        const betaResponse = document.getElementById('beta-response');
        const betaResponseContent = document.getElementById('beta-response-content');
        
        // Переменные для голосового ввода
        let recognition = null;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;
        let betaRecognition = null;
        let isBetaListening = false;
        let betaTranscript = '';
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let javascriptNode = null;
        let bars = [];
        let isProcessingBetaRequest = false;
        
        // История сообщений
        let messageHistory = [
            {
                role: "system",
                content: "You are a helpful assistant. Respond in the same language as the user. Keep your responses clear and concise without any internal thinking tags or explanations about your reasoning process. Just provide the direct answer."
            }
        ];
        
        // Функция обновления статуса
        function updateStatus(isConnected, text) {
            statusIndicator.style.background = isConnected ? '#4ade80' : '#f59e0b';
            statusText.textContent = text;
        }
        
        // Функция добавления сообщения в чат
        function addMessage(content, isUser = false, showAudio = false, autoSpeak = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = isUser ? 'Вы' : 'HypeAI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Очищаем контент от тегов <think> и внутренних размышлений
            const cleanContent = cleanAIResponse(content);
            contentDiv.textContent = cleanContent;
            
            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(contentDiv);
            
            // Добавляем кнопку воспроизведения для AI сообщений
            if (!isUser && showAudio) {
                const audioControls = document.createElement('div');
                audioControls.className = 'audio-controls';
                
                const playButton = document.createElement('button');
                playButton.className = 'play-audio-btn';
                playButton.innerHTML = '🔊 Воспроизвести';
                playButton.onclick = () => speakText(cleanContent, playButton);
                
                audioControls.appendChild(playButton);
                messageDiv.appendChild(audioControls);
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Автоматическое озвучивание для бета-режима
            if (autoSpeak && !isUser) {
                speakText(cleanContent);
            }
            
            // Прокрутка вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Функция очистки ответа AI от тегов <think> и внутренних размышлений
        function cleanAIResponse(content) {
            // Удаляем все теги <think> и их содержимое
            let cleanContent = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
            
            // Если после удаления <think> остался только текст ответа, возвращаем его
            if (cleanContent) {
                return cleanContent;
            }
            
            // Если не было тегов <think>, ищем паттерн с двумя <think> и берем содержимое после второго
            const thinkMatches = content.match(/<think>[\s\S]*?<\/think>\s*<think>([\s\S]*?)<\/think>/);
            if (thinkMatches && thinkMatches[1]) {
                return thinkMatches[1].trim();
            }
            
            // Если ничего не нашли, возвращаем оригинальный контент
            return content.trim();
        }
        
        // Функция для озвучивания текста
        function speakText(text, button = null) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                if (button) {
                    button.classList.remove('playing');
                    button.innerHTML = '🔊 Воспроизвести';
                }
                return;
            }
            
            // Очищаем текст от символов, которые не нужно озвучивать
            const cleanText = text.replace(/[*,_\-~`]/g, ' ').replace(/\s+/g, ' ').trim();
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.2; // Быстрее
            utterance.pitch = 0.9; // Более естественный голос
            
            // Выбираем женский голос для AI
            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => 
                voice.lang.includes('ru') && voice.name.toLowerCase().includes('female')
            ) || voices.find(voice => voice.lang.includes('ru'));
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            }
            
            if (button) {
                button.classList.add('playing');
                button.innerHTML = '⏹️ Остановить';
            }
            
            utterance.onend = function() {
                if (button) {
                    button.classList.remove('playing');
                    button.innerHTML = '🔊 Воспроизвести';
                }
                // После окончания речи продолжаем слушать в бета-режиме
                if (betaInterface.style.display === 'flex' && !isBetaListening && !isProcessingBetaRequest) {
                    startBetaListening();
                }
            };
            
            utterance.onerror = function() {
                if (button) {
                    button.classList.remove('playing');
                    button.innerHTML = '🔊 Воспроизвести';
                }
                // При ошибке тоже продолжаем слушать
                if (betaInterface.style.display === 'flex' && !isBetaListening && !isProcessingBetaRequest) {
                    startBetaListening();
                }
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Функция добавления сообщения об ошибке
        function addErrorMessage(content) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message ai-message error';
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = 'Ошибка';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            errorDiv.appendChild(senderDiv);
            errorDiv.appendChild(contentDiv);
            chatMessages.appendChild(errorDiv);
            
            // Прокрутка вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Функция показа индикатора набора текста
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingDiv.appendChild(dot);
            }
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Функция скрытия индикатора набора текста
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Инициализация распознавания речи для основного чата
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ru-RU';
                
                recognition.onstart = function() {
                    isListening = true;
                    voiceBtn.classList.add('listening');
                    updateStatus(false, 'Слушаю...');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    updateStatus(true, 'Готов к общению');
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    updateStatus(true, 'Готов к общению');
                    addErrorMessage('Ошибка распознавания речи: ' + event.error);
                };
                
                recognition.onend = function() {
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    updateStatus(true, 'Готов к общению');
                };
            } else {
                voiceBtn.disabled = true;
                voiceBtn.title = 'Голосовой ввод не поддерживается вашим браузером';
                addErrorMessage('Голосовой ввод не поддерживается вашим браузером');
            }
        }
        
        // Запуск прослушивания в бета-режиме
        function startBetaListening() {
            if (betaRecognition && !isBetaListening && !isProcessingBetaRequest) {
                betaRecognition.start();
                isBetaListening = true;
            }
        }
        
        // Обработка голосовых команд в бета-режиме
        function processVoiceCommand(transcript) {
            const lowerTranscript = transcript.toLowerCase().trim();
            
            if (lowerTranscript.includes('отмена')) {
                betaTranscript = '';
                transcriptDisplay.textContent = 'Говорите...';
                return true;
            }
            
            if (lowerTranscript.includes('хайп')) {
                // Удаляем команду "хайп" из транскрипта
                const cleanTranscript = transcript.replace(/хайп/gi, '').trim();
                if (cleanTranscript) {
                    betaTranscript = cleanTranscript;
                    processBetaRequest();
                }
                return true;
            }
            
            if (lowerTranscript.includes('стоп')) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                return true;
            }
            
            return false;
        }
        
        // Инициализация бета-режима
        function initBetaMode() {
            // Создаем визуализатор звука
            createVoiceVisualizer();
            
            // Инициализируем распознавание речи для бета-режима
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                betaRecognition = new SpeechRecognition();
                betaRecognition.continuous = true;
                betaRecognition.interimResults = true;
                betaRecognition.lang = 'ru-RU';
                
                betaRecognition.onstart = function() {
                    isBetaListening = true;
                    transcriptDisplay.textContent = 'Говорите...';
                    startVoiceVisualization();
                };
                
                betaRecognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Обновляем транскрипт
                    const currentTranscript = finalTranscript || interimTranscript;
                    betaTranscript = currentTranscript;
                    
                    // Проверяем голосовые команды
                    if (currentTranscript && processVoiceCommand(currentTranscript)) {
                        // Если команда обработана, очищаем транскрипт
                        if (!currentTranscript.includes('хайп')) {
                            betaTranscript = '';
                        }
                    }
                    
                    transcriptDisplay.textContent = betaTranscript || 'Говорите...';
                };
                
                betaRecognition.onerror = function(event) {
                    console.error('Beta speech recognition error', event.error);
                    if (event.error === 'no-speech') {
                        // Продолжаем слушать при отсутствии речи
                        setTimeout(() => {
                            if (betaInterface.style.display === 'flex' && !isBetaListening && !isProcessingBetaRequest) {
                                startBetaListening();
                            }
                        }, 1000);
                    }
                };
                
                betaRecognition.onend = function() {
                    isBetaListening = false;
                    stopVoiceVisualization();
                    // Автоматически перезапускаем прослушивание, если не обрабатываем запрос
                    if (betaInterface.style.display === 'flex' && !isProcessingBetaRequest) {
                        setTimeout(startBetaListening, 500);
                    }
                };
            }
        }
        
        // Создание визуализатора звука
        function createVoiceVisualizer() {
            voiceVisualizer.innerHTML = '';
            bars = [];
            for (let i = 0; i < 50; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = '2px';
                voiceVisualizer.appendChild(bar);
                bars.push(bar);
            }
        }
        
        // Запуск визуализации звука
        function startVoiceVisualization() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        microphone = audioContext.createMediaStreamSource(stream);
                        microphone.connect(analyser);
                        analyser.connect(javascriptNode);
                        javascriptNode.connect(audioContext.destination);
                        
                        analyser.fftSize = 1024;
                        const bufferLength = analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);
                        
                        javascriptNode.onaudioprocess = function() {
                            analyser.getByteFrequencyData(dataArray);
                            const values = Array.from(dataArray).slice(0, 50);
                            
                            bars.forEach((bar, index) => {
                                const value = values[index] || 0;
                                const height = Math.max(2, value / 2);
                                bar.style.height = height + 'px';
                                bar.style.opacity = Math.max(0.3, value / 255);
                            });
                        };
                    })
                    .catch(function(err) {
                        console.error('Error accessing microphone:', err);
                    });
            }
        }
        
        // Остановка визуализации звука
        function stopVoiceVisualization() {
            if (javascriptNode) {
                javascriptNode.onaudioprocess = null;
            }
            if (microphone) {
                microphone.disconnect();
            }
            bars.forEach(bar => {
                bar.style.height = '2px';
                bar.style.opacity = '0.3';
            });
        }
        
        // Обработка запроса в бета-режиме
        function processBetaRequest() {
            if (!betaTranscript.trim() || isProcessingBetaRequest) return;
            
            isProcessingBetaRequest = true;
            
            // Останавливаем прослушивание на время обработки
            if (betaRecognition && isBetaListening) {
                betaRecognition.stop();
            }
            
            // Показываем индикатор загрузки
            transcriptDisplay.textContent = 'Обработка запроса...';
            betaHype.disabled = true;
            
            // Добавляем сообщение в историю
            const tempHistory = [...messageHistory, { role: "user", content: betaTranscript }];
            
            // Отправляем запрос к API
            fetch('https://api.intelligence.io.solutions/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: modelSelect.value,
                    messages: tempHistory,
                    stream: false
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка API: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Получаем ответ от ИИ и очищаем его
                const rawResponse = data.choices[0].message.content;
                const aiResponse = cleanAIResponse(rawResponse);
                
                // Показываем ответ
                betaResponse.style.display = 'block';
                betaResponseContent.textContent = aiResponse;
                
                // Автоматически озвучиваем ответ
                speakText(aiResponse);
                
                // Обновляем историю
                messageHistory = tempHistory;
                messageHistory.push({
                    role: "assistant",
                    content: aiResponse
                });
                
            })
            .catch(error => {
                betaResponse.style.display = 'block';
                betaResponseContent.textContent = `Ошибка: ${error.message}`;
                console.error('Ошибка при отправке сообщения:', error);
            })
            .finally(() => {
                isProcessingBetaRequest = false;
                betaHype.disabled = false;
                betaTranscript = '';
                
                // После обработки продолжаем слушать
                if (betaInterface.style.display === 'flex') {
                    setTimeout(startBetaListening, 1000);
                }
            });
        }
        
        // Функция отправки сообщения
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !modelSelect.value) return;
            
            // Добавляем сообщение пользователя в чат
            addMessage(message, true);
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            voiceBtn.disabled = true;
            
            // Добавляем сообщение в историю
            messageHistory.push({
                role: "user",
                content: message
            });
            
            // Показываем индикатор набора текста
            showTypingIndicator();
            
            // Отправляем запрос к API
            try {
                const response = await fetch('https://api.intelligence.io.solutions/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: messageHistory,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Ошибка API: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                // Скрываем индикатор набора текста
                hideTypingIndicator();
                
                // Получаем ответ от ИИ и очищаем его
                const rawResponse = data.choices[0].message.content;
                const aiResponse = cleanAIResponse(rawResponse);
                
                // Добавляем ответ в чат
                addMessage(aiResponse, false, true);
                
                // Добавляем ответ в историю
                messageHistory.push({
                    role: "assistant",
                    content: aiResponse
                });
                
            } catch (error) {
                // Скрываем индикатор набора текста
                hideTypingIndicator();
                
                // Показываем ошибку
                addErrorMessage(`Ошибка соединения: ${error.message}`);
                console.error('Ошибка при отправке сообщения:', error);
            } finally {
                // Включаем поле ввода
                messageInput.disabled = false;
                sendButton.disabled = false;
                voiceBtn.disabled = false;
                messageInput.focus();
            }
        }
        
        // Обработчики событий
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
        
        voiceBtn.addEventListener('click', () => {
            if (!recognition) return;
            
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });
        
        // Бета-режим обработчики
        betaBtn.addEventListener('click', () => {
            betaInterface.style.display = 'flex';
            initBetaMode();
            startBetaListening();
        });
        
        closeBeta.addEventListener('click', () => {
            betaInterface.style.display = 'none';
            if (betaRecognition && isBetaListening) {
                betaRecognition.stop();
            }
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            isProcessingBetaRequest = false;
        });
        
        betaCancel.addEventListener('click', () => {
            betaTranscript = '';
            transcriptDisplay.textContent = 'Говорите...';
        });
        
        betaHype.addEventListener('click', () => {
            if (betaTranscript.trim()) {
                processBetaRequest();
            }
        });
        
        betaStop.addEventListener('click', () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        });
        
        // Инициализация чата
        window.addEventListener('load', () => {
            updateStatus(true, 'Готов к общению');
            messageInput.focus();
            initSpeechRecognition();
            
            // Ждем загрузки голосов для синтеза речи
            speechSynthesis.onvoiceschanged = function() {
                console.log('Voices loaded');
            };
        });
    </script>
</body>
</html>